MATHEMATICAL FOUNDATIONS: UNIVERSAL 6DOF MOTION TRACKING
=========================================================


1. SIX DEGREES OF FREEDOM (6DOF) REPRESENTATION
================================================

A rigid body in 3D space has exactly 6 independent parameters:
- 3 translational (position): x, y, z
- 3 rotational (orientation): roll, pitch, yaw (or quaternion)

Position Vector:
    p = [x, y, z]^T ∈ R³

Orientation (Quaternion):
    q = w + xi + yj + zk = [w, x, y, z]^T
    
    where ||q|| = 1 (unit quaternion)

The quaternion representation avoids gimbal lock and provides smooth interpolation.


2. QUATERNION MATHEMATICS
==========================

Quaternion Multiplication (Hamilton Product):
    q₁ ⊗ q₂ = [w₁w₂ - v₁·v₂, w₁v₂ + w₂v₁ + v₁×v₂]
    
    where v = [x, y, z]

Rotation of Vector by Quaternion:
    v' = q ⊗ [0, v] ⊗ q*
    
    where q* = [w, -x, -y, -z] is the conjugate

Quaternion to Rotation Matrix:
    R = [1-2(y²+z²)   2(xy-wz)    2(xz+wy) ]
        [2(xy+wz)     1-2(x²+z²)  2(yz-wx) ]
        [2(xz-wy)     2(yz+wx)    1-2(x²+y²)]

SLERP (Spherical Linear Interpolation):
    SLERP(q₁, q₂, t) = sin((1-t)θ)/sin(θ) · q₁ + sin(tθ)/sin(θ) · q₂
    
    where θ = arccos(q₁ · q₂)


3. DENAVIT-HARTENBERG KINEMATIC CHAIN
======================================

Each joint in the kinematic chain is described by 4 DH parameters:
- θ (theta): Joint angle (rotation around z-axis)
- d: Link offset (translation along z-axis)
- a: Link length (translation along x-axis)
- α (alpha): Link twist (rotation around x-axis)

Transformation Matrix for Joint i:
    Tᵢ = Rz(θᵢ) · Tz(dᵢ) · Tx(aᵢ) · Rx(αᵢ)

    = [cos(θ)  -sin(θ)cos(α)   sin(θ)sin(α)   a·cos(θ)]
      [sin(θ)   cos(θ)cos(α)  -cos(θ)sin(α)   a·sin(θ)]
      [0        sin(α)         cos(α)         d       ]
      [0        0              0              1       ]

Forward Kinematics (end-effector pose):
    T₀ₙ = T₁ · T₂ · T₃ · ... · Tₙ

Human Arm Chain (7 DOF):
    Joint 1-3: Shoulder (flexion, abduction, rotation)
    Joint 4: Elbow (flexion)
    Joint 5: Forearm (pronation/supination)
    Joint 6-7: Wrist (flexion, deviation)


4. RIGID BODY DYNAMICS
=======================

For an object (racket) held by the wrist:

Position:
    p_racket = p_wrist + R_wrist · r_grip
    
    where r_grip is the grip offset in wrist frame

Velocity:
    v_racket = v_wrist + ω_wrist × (p_racket - p_wrist)
    
    where ω is angular velocity

Racket Face Normal:
    n_face = R_racket · [0, 0, 1]^T
    
    The Z-axis of the racket local frame points perpendicular to string bed.


5. EXTENDED KALMAN FILTER (EKF)
================================

State Vector (13 elements):
    x = [p_x, p_y, p_z, v_x, v_y, v_z, q_w, q_x, q_y, q_z, ω_x, ω_y, ω_z]^T

State Transition (constant velocity model):
    p' = p + v·Δt
    v' = v
    q' = q ⊗ exp(ω·Δt/2)
    ω' = ω

Prediction Step:
    x̂⁻ = f(x̂, Δt)
    P⁻ = F · P · F^T + Q

Update Step (with measurement z):
    K = P⁻ · H^T · (H · P⁻ · H^T + R)⁻¹
    x̂ = x̂⁻ + K · (z - h(x̂⁻))
    P = (I - K · H) · P⁻

Jacobians:
    F = ∂f/∂x (state transition Jacobian)
    H = ∂h/∂x (measurement Jacobian)


6. INVERSE KINEMATICS
======================

Given target end-effector position p_target, find joint angles θ.

Geometric Jacobian:
    J = [∂p/∂θ₁, ∂p/∂θ₂, ..., ∂p/∂θ₇]   (3×7 matrix)

Damped Least Squares Solution:
    Δθ = J^T · (J·J^T + λ²·I)⁻¹ · e
    
    where e = p_target - p_current
    and λ is damping factor for singularity avoidance

Iterative Update:
    θ_{k+1} = θ_k + Δθ
    
    Repeat until ||e|| < tolerance


7. COORDINATE TRANSFORMATION
=============================

Apple Vision (Right-Handed) to Unity (Left-Handed):

Position:
    p_unity = [p_x, p_y, -p_z]

Quaternion:
    q_unity = [w, -x, -y, z]

Rotation Matrix:
    R_unity = R_apple · diag([1, 1, -1])
    
    (Negate third column and row of rotation component)


8. ROLLING SHUTTER COMPENSATION
================================

iPhone sensor reads line-by-line. For a point at pixel row y:

Time Offset:
    Δt = (y / H) · t_readout
    
    where H is frame height, t_readout ≈ 20ms at 30fps

Position Correction:
    p_corrected = p_detected - v · Δt
    
    Requires velocity estimate from kinematics or previous frames.


9. BIOMECHANICAL CONSTRAINTS
=============================

Joint Limits (typical values):
    Shoulder flexion: -60° to 180°
    Shoulder abduction: -45° to 180°
    Shoulder rotation: -90° to 90°
    Elbow flexion: 0° to 143°
    Forearm pronation: -90° to 90°
    Wrist flexion: -60° to 60°
    Wrist deviation: -30° to 45°

Segment Length Ratios (relative to body height):
    Upper arm: 0.186
    Forearm: 0.146
    Hand: 0.108

These constraints ensure physically plausible poses.


10. MINIMUM JERK TRAJECTORY
============================

Human movements minimize jerk (third derivative of position).

Cost Functional:
    J = ∫₀ᵀ (d³x/dt³)² dt

Optimal Trajectory (5th order polynomial):
    x(t) = x₀ + (x_f - x₀) · [10τ³ - 15τ⁴ + 6τ⁵]
    
    where τ = t/T, T is movement duration

Used for:
- Filling occlusion gaps
- Predicting future trajectory
- Detecting anomalies (deviation from minimum jerk)


11. HYBRID FUSION ALGORITHM
============================

Combine ML predictions with kinematic model:

Adaptive Weight:
    w = f(speed, confidence, occlusion)
    
    w → 1 when: high speed OR low confidence OR occluded
    w → 0 when: low speed AND high confidence AND visible

Fused Position:
    p_fused = w · p_kinematic + (1-w) · p_ML

Fused Orientation (SLERP):
    q_fused = SLERP(q_ML, q_kinematic, w)


IMPLEMENTATION NOTES
====================

The Universal6DoFTracker class implements all of these mathematical foundations:

1. Quaternion class: Full quaternion algebra
2. HumanArmKinematicChain: 7-DOF DH chain with forward kinematics
3. RacketTracker: Rigid body extension from wrist
4. EKF6DoF: Full 13-state Extended Kalman Filter
5. InverseKinematicsSolver: Damped least squares IK

This provides a mathematically rigorous, universal solution that works with any pose estimation input source.


REFERENCES
==========

1. Craig, J.J. (2005). Introduction to Robotics: Mechanics and Control, 3rd ed.
2. Diebel, J. (2006). Representing Attitude: Euler Angles, Unit Quaternions, and Rotation Vectors.
3. Zatsiorsky, V.M. (2002). Kinetics of Human Motion.
4. Flash, T. & Hogan, N. (1985). The Coordination of Arm Movements: An Experimentally Confirmed Mathematical Model. Journal of Neuroscience.
5. Welch, G. & Bishop, G. (2006). An Introduction to the Kalman Filter.

